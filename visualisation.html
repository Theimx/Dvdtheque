<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>DVDthÃ¨que</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>ğŸ“‹ Ma DVDthÃ¨que</h1>
  <a class="nav-btn" href="ajout.html">â• Ajouter un DVD</a>
</header>

<div class="card">
  <button class="primary" onclick="ouvrirCSV()">ğŸ“‚ Ouvrir dvdtheque.csv</button>
</div>

<div id="grid" class="grid"></div>

<script>
let fileHandle;
let dvds = [];
const grid = document.getElementById("grid");

async function ouvrirCSV() {
  [fileHandle] = await window.showOpenFilePicker({
    types: [{ description: "DVDthÃ¨que", accept: { "text/csv": [".csv"] } }]
  });

  const file = await fileHandle.getFile();
  const text = await file.text();
  chargerCSV(text);
  render();
}

function chargerCSV(text) {
  const lines = text.split("\n").slice(1);
  dvds = lines.filter(l => l.trim()).map(l => {
    const v = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(x => x.replace(/"/g, ""));
    return {
      titre:v[0], annee:v[1], genres:v[2], realisateurs:v[3],
      pays:v[4], acteurs:v[5], palme:v[6], recompense:v[7],
      duree:v[8], coffret:v[9], groupe:v[10],
      prix:v[11], support:v[12]
    };
  });
}

function render() {
  grid.innerHTML = "";
  dvds.forEach((d, i) => {
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <h2>${d.titre}</h2>
      <p>${d.annee} â€¢ ${d.support}</p>
      <p>${d.genres}</p>
      <p>ğŸ¬ ${d.realisateurs}</p>
      <p>ğŸŒ ${d.pays}</p>
      <p>â± ${d.duree} min</p>
      <p>ğŸ† Palme d'Or : ${d.palme}</p>
      <p>ğŸ Coffret : ${d.coffret} ${d.groupe ? "(" + d.groupe + ")" : ""}</p>
      <p>ğŸ’° ${d.prix} â‚¬</p>
      <button class="danger" onclick="supprimer(${i})">âŒ Supprimer</button>
    `;
    grid.appendChild(c);
  });
}

async function sauvegarderCSV() {
  const writable = await fileHandle.createWritable();
  let csv = "Titre,AnnÃ©e,Genres,Realisateurs,Pays,Acteurs,PalmeOr,AutreRecompense,Duree,Coffret,GroupeCoffret,Prix,Support\n";
  dvds.forEach(d => {
    csv += Object.values(d).map(v => `"${v || ""}"`).join(",") + "\n";
  });
  await writable.write(csv);
  await writable.close();
}

async function supprimer(i) {
  if (confirm("Supprimer ce DVD ?")) {
    dvds.splice(i, 1);
    await sauvegarderCSV();
    render();
  }
}
</script>

</body>
</html>