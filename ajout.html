<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ajouter un DVD</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>ğŸ“€ Ajouter un DVD</h1>
  <a class="nav-btn" href="visualisation.html">ğŸ“‹ Voir la DVDthÃ¨que</a>
</header>

<div class="card">
  <button class="primary" onclick="ouvrirCSV()">ğŸ“‚ Ouvrir dvdtheque.csv</button>
  <p class="info">Ã€ faire une seule fois au dÃ©marrage</p>
</div>

<form id="form" class="card">
  <input id="titre" placeholder="Titre" required>
  <input id="annee" type="number" placeholder="AnnÃ©e">
  <input id="genres" placeholder="Genres">
  <input id="realisateurs" placeholder="RÃ©alisateurs">
  <input id="pays" placeholder="Pays d'origine">
  <input id="acteurs" placeholder="Acteurs">

  <div class="checkbox">
    <label><input type="checkbox" id="palme"> Palme d'Or</label>
    <label><input type="checkbox" id="recompense"> Autre rÃ©compense</label>
  </div>

  <input id="duree" type="number" placeholder="DurÃ©e (minutes)">
  <label><input type="checkbox" id="coffret"> Coffret</label>
  <input id="groupe" placeholder="Nom du coffret">

  <input id="prix" type="number" step="0.01" placeholder="Prix (â‚¬)">
  <select id="support">
    <option>DVD</option>
    <option>Blu-ray</option>
    <option>4K</option>
  </select>

  <button class="primary">â• Ajouter</button>
</form>

<script>
let fileHandle;
let dvds = [];

async function ouvrirCSV() {
  [fileHandle] = await window.showOpenFilePicker({
    types: [{ description: "DVDthÃ¨que", accept: { "text/csv": [".csv"] } }]
  });

  const file = await fileHandle.getFile();
  const text = await file.text();
  chargerCSV(text);
}

function chargerCSV(text) {
  const lines = text.split("\n").slice(1);
  dvds = lines.filter(l => l.trim()).map(l => {
    const v = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(x => x.replace(/"/g, ""));
    return {
      titre:v[0], annee:v[1], genres:v[2], realisateurs:v[3],
      pays:v[4], acteurs:v[5], palme:v[6], recompense:v[7],
      duree:v[8], coffret:v[9], groupe:v[10],
      prix:v[11], support:v[12]
    };
  });
}

async function sauvegarderCSV() {
  const writable = await fileHandle.createWritable();
  let csv = "Titre,AnnÃ©e,Genres,Realisateurs,Pays,Acteurs,PalmeOr,AutreRecompense,Duree,Coffret,GroupeCoffret,Prix,Support\n";
  dvds.forEach(d => {
    csv += Object.values(d).map(v => `"${v || ""}"`).join(",") + "\n";
  });
  await writable.write(csv);
  await writable.close();
}

form.onsubmit = async e => {
  e.preventDefault();
  dvds.push({
    titre:titre.value,
    annee:annee.value,
    genres:genres.value,
    realisateurs:realisateurs.value,
    pays:pays.value,
    acteurs:acteurs.value,
    palme:palme.checked ? "Oui" : "Non",
    recompense:recompense.checked ? "Oui" : "Non",
    duree:duree.value,
    coffret:coffret.checked ? "Oui" : "Non",
    groupe:groupe.value,
    prix:prix.value,
    support:support.value
  });
  await sauvegarderCSV();
  form.reset();
  alert("DVD ajoutÃ© et sauvegardÃ© !");
};
</script>

</body>
</html>